{% extends 'base.html.twig' %}

{% block title %}Перенос записи{% endblock %}
{% block breadcrumbs %} <p class="breadcrumbs" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }"><span
            class="mr-2"><a href="{{ path('app_home') }}">Home</a></span>
    <a href="{{ path('app_employee_records') }}"><span>Активные записи</span></a><
    <span>Редактирование</span>/p> {% endblock %}
    {% block body %}
    <div class="overlay" style="background-color: hotpink">
        <form action="{{ path('app_visit_move', {'id' : visit.id}) }}" method="POST" enctype="multipart/form-data"
              class="appointment-form">
            <input type="hidden" name="_token" value="{{ csrf_token('csrf_token') }}">
            <div class="row form-group d-flex" style="margin-left: 20%; margin-right: 20%">
                <div class="col-md-6">
                    <div class="input-wrap">
                        <div class="icon"><span class="ion-md-calendar"></span></div>
                        <input type="text" name="date" id="appointment_date" class="form-control"
                               placeholder="Date">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-wrap">
                        <div class="icon"><span class="ion-md-calendar"></span></div>
                        <input type="text" name="time" id="appointment_time" class="form-control"
                               placeholder="Time" disabled>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <input type="submit" style="margin-left: 45%; position: relative" value="Перенести" class="btn btn-white btn-outline-white py-3 px-4">
            </div>
        </form>
</div>

            <script src="https://code.jquery.com/jquery-3.6.1.js"
                    integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
            <script type="text/javascript">
                let employeeId = {{ employeeId }}
                    $(document).ready(function () {
                        $('#appointment_date').on("changeDate", function (event) {
                            event.preventDefault();
                            var value = $(this).val();
                            $.ajax({
                                url: '{{ (path('app_employee_occupation')) }}',
                                type: "POST",
                                data: {
                                    "date": value,
                                    "employeeId": employeeId
                                },
                                success: function (data) {
                                    $("#appointment_time").removeAttr('disabled');
                                    let timeRange = [];
                                    let workingHours = [];
                                    console.log(data);
                                    Object.values(data['occupation']).forEach(element => timeRange.push(Object.values(element)))
                                    workingHours = Object.values(data['workingHours'])

                                    var dateNow = new Date(Date.now());
                                    if(value === dateNow.toISOString().split('T')[0]){
                                        timeRange.push([workingHours['0'], dateNow.getHours() + ':' + dateNow.getMinutes()]);
                                    }

                                    $('#appointment_time').timepicker('remove');
                                    $('#appointment_time').timepicker({
                                        'showMeridian': false,
                                        'timeFormat': 'H:i',
                                        'minTime': workingHours['0'],
                                        'maxTime': workingHours['1'],
                                        'disableTimeRanges': timeRange,
                                    });
                                },
                                error: function (err) {
                                    console.log(err.statusText);
                                }
                            });

                            return false;
                        })
                    });
            </script>

    </div>
{% endblock %}